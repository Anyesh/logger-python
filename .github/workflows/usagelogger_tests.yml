name: Unit and Integration test the usagelogger

on:
  [push]
  # push:
  #   branches:
  #     - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - run: |
          git fetch --prune --unshallow

      - name: Set up Python 3.7
        uses: actions/setup-python@v1
        with:
          python-version: "3"
          architecture: x64

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements_dev.txt

      - name: Run unit tests
        run: |
          pytest
      - name: Setting up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7
          bundler-cache: true
        env:
          ImageOS: "ubuntu18"
          HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      - uses: akhileshns/heroku-deploy@v3.10.9
        with:
          heroku_api_key: $HEROKU_API_KEY
          heroku_email: "sthacruz@gmail.com" 
          dontautocreate: true
          justlogin: true
          
      - run: heroku auth:whoami
          
      - name: Run integration tests
        env:
          AUTHTOKEN: ${{ secrets.AUTHTOKEN }}
        run: |
          git clone https://Anyesh:$AUTHTOKEN@github.com/Anyesh/logger-tests
          cd ./logger-tests
          gem install bundler
          bundle update --bundler
          bundle install
          bundle exec rspec spec/integration/python
